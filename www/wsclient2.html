<!doctype html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <title>Bootstrap tutorial</title>
      <link rel="icon" type="image/x-icon" href="/images/favicons/favicon.ico">
      <link rel="icon" href="/images/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
      <link rel="icon" href="/images/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
      <link rel="icon" href="/images/favicons/favicon.ico">
      <meta name="description" content="Example of Bootstrap">
      <!-- <link rel="stylesheet" href="/assets/css/bootstrap.min.css"> -->
      <!-- <link rel="stylesheet" href="/assets/font/bootstrap-icons.css"><link rel="stylesheet" href="/assets/css/docs.css"> -->
      <!-- <link rel="apple-touch-icon" href="/assets/img/favicons/apple-touch-icon.png" sizes="180x180"> -->

      <!-- Latest compiled and minified CSS -->
      <link href="/css/bootstrap.min.css" rel="stylesheet">

      <!-- Latest compiled JavaScript -->
      <script src="/javascript/bootstrap.bundle.min.js"></script>

      <!-- WebSocket JavaScript -->
      <script src="/javascript/wsclient2.js"></script>

      <style>
         .btn-size-150 {
            min-width: 150px;
         }

         body {
           background-color: #f5f5f5;
         }
      </style>
   </head>

   <body>
      <div class="container">
         <h1>WebSocket Example</h1>
         <form>
            <!-- Hostname -->
           <div class="row mb-3">
             <label for="inputHostname" class="col-sm-2 col-form-label">Hostname</label>
             <div class="col-sm-10">
               <input type="test" class="form-control" id="inputHostname" placeholder="Hostname of WebSocket server">
             </div>
           </div>
           <!-- TCP port # -->
           <div class="row mb-3">
             <label for="inputPort" class="col-sm-2 col-form-label">Port</label>
             <div class="col-sm-10">
               <input type="text" class="form-control" id="inputPort"  placeholder="TCP port of WebSocket server">
             </div>
           </div>
           <!-- WebSocket end point -->
           <div class="row mb-3">
             <label for="inputEndpoint" class="col-sm-2 col-form-label">Endpoint</label>
             <div class="col-sm-10">
               <input type="text" class="form-control" id="inputEndpoint"  placeholder="Endpoint (optional)">
             </div>
           </div>

           <!-- Select WebSocket protocol -->
           <fieldset class="row mb-3">
             <legend class="col-form-label col-sm-2 pt-0">Protocol</legend>
             <div class="col-sm-10">
                <select class="form-select" id="selectProtocol" aria-label="Default select example">
                  <option selected>select the WebSocket protocol</option>
                  <option value="ws://">ws:// (WebSocket)</option>
                  <option value="wss://">wss:// (Secure WebSocket)</option>
                </select>
             </div>
           </fieldset>

           </div>
           <div class="container">
              <div class="row row-cols-auto">
                 <div class="col">
                    <!-- <input class="btn btn-primary" id="btnConnect" type="button" value="Connect" onclick="onConnectClick()"> -->
                    <button class="btn btn-primary btn-size-150" id="btnConnect" type="button" onclick="onConnectClick()">
                       <span class="" id="btnConnectSpinner" role="status" aria-hidden="true"></span>
                       Connect
                    </button>
                 </div>
                 <div class="col">
                    <button class="btn btn-primary btn-size-150 disabled" id="btnDisconnect" type="button" onclick="onDisconnectClick()">
                       Disconnect
                    </button>
                 </div>
              </div>
              <br>

              <div class="row row-cols-auto">
                 <div class="col-6">
                    <div class="alert alert-danger" role="alert" id="alert_connection">
                       Disconnected...
                    </div>
                 </div>
              </div>
           </div>
         </form>

        <!-- Send Message Form -->
        <div class="container">
           <form class="row g-3">
             <div class="col-auto">
               <label for="staticMessage" class="col-form-label">Message to server</label>
             </div>
             <div class="col-auto col-6">
               <input type="text" class="form-control" id="inputMessage" placeholder="Message to server">
             </div>
             <div class="col-auto">
               <!-- <button type="submit" class="btn btn-primary mb-3">Send message</button> -->
               <button class="btn btn-primary" id="btnSendMsg" type="button" onclick="onSendClick()">
                  Send message
               </button>
             </div>
           </form>
        </div>
        <br>

        <!-- Receive Message input -->
        <div class="container">
          <div class="row g-2">
             <label for="exampleFormControlTextarea1" class="form-label">Message from server</label>
             <textarea class="form-control" id="incomingMsgOutput" rows="5" readonly></textarea>
          </div>
        </div>

         <!-- The Modal: Error window -->
         <div class="modal" id="errorModal">
           <div class="modal-dialog  modal-xl">
             <div class="modal-content">

               <!-- Modal Header -->
               <div class="modal-header">
                 <h4 class="modal-title" id="errorModalHeader">Modal Heading</h4>
                 <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
               </div>

               <!-- Modal body -->
               <div class="modal-body" id="errorModalBody">
                 Modal body..
               </div>

               <!-- Modal footer -->
               <div class="modal-footer">
                 <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
               </div>

             </div>
           </div>
         </div>
         <!-- The Modal: Error window -->
      </div>

      <script>
         var webSocket   = null;

         function onConnectClick() {
            // get information from input fields
            var ws_hostname = document.getElementById("inputHostname").value;
            var ws_port     = document.getElementById("inputPort").value;
            var ws_endpoint = document.getElementById("inputEndpoint").value;
            // var ws_protocol = document.querySelector('input[name = gridRadios]:checked').value;
            var ws_protocol = document.getElementById("selectProtocol").value;

            var webSocketURL = ws_protocol + ws_hostname + ":" + ws_port + "/" + ws_endpoint;
            openWSConnection(ws_protocol, ws_hostname, ws_port, ws_endpoint);
            console.log(webSocketURL);
         }
         function onDisconnectClick() {
            webSocket.close();
            document.getElementById("incomingMsgOutput").value = "";
            console.log(document.getElementById("alert_connection").className);
         }

         // add a spinner to the connect button and disable it
         function onSpinner() {
            document.getElementById("btnConnectSpinner").classList.add("spinner-border");
            document.getElementById("btnConnectSpinner").classList.add("spinner-border-sm");
            document.getElementById("btnConnect").classList.add("disabled");
         }

         // remove the spinner to the connect button and enable it
         function offSpinner() {
            document.getElementById("btnConnectSpinner").classList.remove("spinner-border");
            document.getElementById("btnConnectSpinner").classList.remove("spinner-border-sm");
            document.getElementById("btnConnect").classList.remove("disabled");
         }

         addEventListener('DOMContentLoaded', (event) => {
             // console.log('(1) The DOM is fully loaded.');
         });

         addEventListener('load', (event) => {
             // console.log('(3) The page is fully loaded.');
         });

         addEventListener('beforeunload', (event) => {
             // show the confirmation dialog
             event.preventDefault();
             // Google Chrome requires returnValue to be set.
             event.returnValue = '';
         });

         addEventListener('unload', (event) => {
             // send analytic data
         });

         /**
          * Open a new WebSocket connection using the given parameters
          */
         function openWSConnection(protocol, hostname, port, endpoint) {
             var webSocketURL = null;
             webSocketURL = protocol + hostname + ":" + port + "/" + endpoint;
             console.log("openWSConnection::Connecting to: " + webSocketURL);
             onSpinner();
             try {
                 webSocket = new WebSocket(webSocketURL);
                 webSocket.onopen = function(openEvent) {
                     console.log("WebSocket OPEN: " + JSON.stringify(openEvent, null, 4));
                     document.getElementById("alert_connection").classList.remove("alert-danger");
                     document.getElementById("alert_connection").classList.add("alert-success");
                     document.getElementById("alert_connection").innerHTML="Connected to: " + "<b>" + webSocketURL + "</b>";
                     // document.getElementById("alert_connection").textContent="Connected to " + "<b>" + webSocketURL + "</b>";

                     document.getElementById("btnDisconnect").classList.remove("disabled");
                     document.getElementById("btnConnect").classList.add("disabled");
                     document.getElementById("btnConnectSpinner").classList.remove("spinner-border");
                     document.getElementById("btnConnectSpinner").classList.remove("spinner-border-sm");

                 };
                 webSocket.onclose = function (closeEvent) {
                     console.log("WebSocket CLOSE: " + JSON.stringify(closeEvent, null, 4));
                     document.getElementById("alert_connection").classList.remove("alert-success");
                     document.getElementById("alert_connection").classList.add("alert-danger");
                     document.getElementById("alert_connection").textContent="Disconnected...";

                     document.getElementById("btnDisconnect").classList.add("disabled");
                     document.getElementById("btnConnect").classList.remove("disabled");
                 };
                 webSocket.onerror = function (errorEvent) {
                     console.log("WebSocket ERROR: " + JSON.stringify(errorEvent, null, 4));
                     var galleryModal = new bootstrap.Modal(document.getElementById('errorModal'))
                     document.getElementById("errorModalBody").innerHTML="WebSocket ERROR: " + JSON.stringify(errorEvent, null, 4);
                     document.getElementById("errorModalHeader").innerHTML="WebSocket error!";
                     galleryModal.show();
                     offSpinner();
                 };
                 webSocket.onmessage = function (messageEvent) {
                     var wsMsg = messageEvent.data;
                     console.log("WebSocket MESSAGE: " + wsMsg);
                     if (wsMsg.indexOf("error") > 0) {
                         document.getElementById("incomingMsgOutput").value += "error: " + wsMsg.error + "\r\n";
                     } else {
                         document.getElementById("incomingMsgOutput").value += "Rx: " + wsMsg + "\r\n";
                     }
                 };
             } catch (exception) {
               console.error("webSocket fatal console.error();: " + exception);
               var galleryModal = new bootstrap.Modal(document.getElementById('errorModal'))
               document.getElementById("errorModalBody").innerHTML=exception;
               document.getElementById("errorModalHeader").innerHTML="WebSocket fatal error!";
               galleryModal.show();
               offSpinner();
             }
         }

         /**
          * Send a message to the WebSocket server
          */
         function onSendClick() {
            var galleryModal = new bootstrap.Modal(document.getElementById('errorModal'))
            if (webSocket == null) {
               console.error("webSocket not initialize. Can't send");
               document.getElementById("errorModalBody").innerHTML="wwebSocket not initialize. Can't send";
               document.getElementById("errorModalHeader").innerHTML="WebSocket warning";
               galleryModal.show();
               return;
            }
             if (webSocket.readyState != WebSocket.OPEN) {
                 console.error("webSocket is not open: " + webSocket.readyState);
                 document.getElementById("errorModalBody").innerHTML="webSocket is not open: " + webSocket.readyState;
                 document.getElementById("errorModalHeader").innerHTML="WebSocket warning";
                 galleryModal.show();
                 return;
             }
             var msg = document.getElementById("inputMessage").value;
             webSocket.send(msg);
         }

      </script>
   </body>
</html>
